<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Bella Italia - Digitale Speisekarte</title>
    <style>
        /* Bestehendes CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f8f8;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative; 
        }

        h1 {
            color: #2c5530;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #2c5530;
            background: white;
            color: #2c5530;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active,
        .filter-btn:hover {
            background: #2c5530;
            color: white;
        }

        .favorites-btn {
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .menu-categories {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .category-btn {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .category-btn.active {
            background: #2c5530;
            color: white;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        /* Bearbeiten/L√∂schen Buttons im Admin-Modus */
        .admin-controls-item {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .admin-edit-btn, .admin-delete-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .admin-edit-btn { background: #f39c12; color: white; }
        .admin-delete-btn { background: #e74c3c; color: white; }


        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .menu-item h3 {
            color: #2c5530;
            margin-bottom: 10px;
        }

        .price {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.2em;
            margin: 10px 0;
        }

        .description {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            background: #f0f0f0;
        }

        .tag.vegan { background: #d4edda; color: #155724; }
        .tag.vegetarisch { background: #d1ecf1; color: #0c5460; }
        .tag.scharf { background: #f8d7da; color: #721c24; }

        /* Popup Styles */
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: #666;
        }

        .popup-image {
            width: 100%;
            height: 200px;
            background: #eee;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            overflow: hidden;
        }
        
        .popup-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .favorite-popup-btn {
            width: 100%;
            padding: 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 16px;
        }

        .favorite-popup-btn.added {
            background: #27ae60;
        }

        /* Favorites View (unver√§ndert) */
        .favorites-view {
            display: none;
        }

        .back-btn {
            padding: 10px 20px;
            background: #666;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        /* Admin Area Styles */
        #adminArea {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
            display: none;
        }

        #adminArea h2 {
            color: #3498db;
            margin-bottom: 20px;
        }

        .admin-form-group {
            margin-bottom: 15px;
        }

        .admin-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .admin-form-group input[type="text"],
        .admin-form-group input[type="file"],
        .admin-form-group input[type="number"],
        .admin-form-group select,
        .admin-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }

        .admin-form-group textarea {
            resize: vertical;
        }
        
        #imagePreview {
            width: 100%;
            height: 150px;
            background: #f0f0f0;
            border: 1px dashed #ccc;
            margin-top: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            overflow: hidden;
            border-radius: 5px;
        }
        
        #imagePreview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .admin-action-btn {
            padding: 10px 20px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            margin-right: 10px;
            transition: background 0.3s;
        }
        
        .admin-action-btn.logout {
            background: #e74c3c;
        }
        
        .admin-action-btn.logout:hover {
            background: #c0392b;
        }
        
        .admin-action-btn:hover {
            background: #27ae60;
        }

        /* Separator im Admin-Bereich */
        .admin-separator {
            border-top: 1px solid #eee;
            margin: 20px 0;
        }

        /* Media Queries (unver√§ndert) */
        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .filter-buttons {
                justify-content: center;
            }
        }

        /* Zus√§tzliche styles f√ºr Kategorie-Liste im Admin (harmonisch gehalten) */
        .category-admin-list {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .category-admin-item {
            display:flex;
            gap:8px;
            align-items:center;
            justify-content:space-between;
            background:#fafafa;
            padding:8px;
            border-radius:6px;
            border:1px solid #eee;
        }
        .category-admin-item .left {
            display:flex;
            gap:8px;
            align-items:center;
        }
        .category-admin-item button {
            padding:6px 10px;
            border-radius:6px;
            border:none;
            cursor:pointer;
        }
        .category-edit-btn { background:#f39c12; color:white; }
        .category-delete-btn { background:#e74c3c; color:white; }
        .category-move-btn { 
            background: #3498db; 
            color: white; 
            padding: 6px 8px;
        }
        .category-move-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçù Restaurant Bella Italia</h1>
            <p>Willkommen zu unserer digitalen Speisekarte</p>
        </header>
        
        
<div id="adminArea">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2>Admin-Bereich üîí</h2>
                <button type="button" class="admin-action-btn logout" id="adminLogoutBtn">Admin Logout</button>
            </div>
            <p>Dr√ºcken Sie <code>Strg + Alt + A</code> (oder <code>Cmd + Alt + A</code> auf Mac), um den Admin-Bereich zu √∂ffnen.</p>
            
            <form id="menuItemForm">
                <h3>Men√ºpunkt hinzuf√ºgen/bearbeiten</h3>
                <input type="hidden" id="mealIdInput" value="">
                
                <div class="admin-form-group">
                    <label for="mealName">Name des Gerichts</label>
                    <input type="text" id="mealName" required>
                </div>
                
                <div class="admin-form-group">
                    <label for="mealCategory">Kategorie</label>
                    <select id="mealCategory" required>
                        <!-- Wird dynamisch gef√ºllt -->
                    </select>
                </div>
                
                <div class="admin-form-group">
                    <label for="mealPrice">Preis (‚Ç¨)</label>
                    <input type="number" id="mealPrice" step="0.01" required>
                </div>
                
                <div class="admin-form-group">
                    <label for="mealDescription">Beschreibung</label>
                    <textarea id="mealDescription" rows="3" required></textarea>
                </div>
                
                <div class="admin-form-group">
                    <label for="mealTags">Tags (durch Komma trennen: z.B. vegetarisch,scharf)</label>
                    <input type="text" id="mealTags" placeholder="vegetarisch,scharf">
                </div>
                
                <div class="admin-form-group">
                    <label for="mealIngredients">Zutaten (durch Komma trennen)</label>
                    <input type="text" id="mealIngredients" placeholder="Baguette,Tomaten,Basilikum">
                </div>

                <div class="admin-form-group">
                    <label for="mealImageFile">Bilddatei hochladen (wird automatisch verkleinert)</label>
                    <input type="file" id="mealImageFile" accept="image/jpeg, image/png">
                    <div id="imagePreview">Bildvorschau</div>
                </div>
                
                <button type="submit" class="admin-action-btn" id="saveMealBtn">Men√ºpunkt speichern</button>
                <button type="button" class="admin-action-btn" id="resetFormBtn" style="background:#e67e22;">Formular zur√ºcksetzen</button>
                
            </form>
            
            <div class="admin-separator"></div>

            <h3>Aktuelle Gerichte (bearbeiten durch Klick im Men√º)</h3>
            <p>Klicken Sie auf ein Gericht unten in der Speisekarte, um es im Bearbeitungsformular zu laden.</p>

            <div class="admin-separator"></div>

            <!-- NEU: Kategorie Verwaltung im Admin Bereich (nahtlos passend) -->
            <h3>Kategorien verwalten</h3>
            <form id="categoryAdminForm" style="margin-bottom:10px;">
                <div class="admin-form-group">
                    <label for="newCategoryInput">Neue Kategorie hinzuf√ºgen</label>
                    <input type="text" id="newCategoryInput" placeholder="z. B. vorspeisen, suppen..." required>
                </div>
                <button type="submit" class="admin-action-btn">Kategorie hinzuf√ºgen</button>
            </form>

            <div id="categoryAdminList" class="category-admin-list"></div>

        </div>
        
        <div class="controls">
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Alle</button>
                <button class="filter-btn" data-filter="vegetarisch">Vegetarisch</button>
                <button class="filter-btn" data-filter="vegan">Vegan</button>
            </div>
            <button class="favorites-btn" id="showFavorites">‚≠ê Favoriten anzeigen</button>
        </div>

        <div class="menu-categories" id="menuCategoriesContainer">
            <!-- Kategorien werden dynamisch gerendert -->
        </div>

        <div class="menu-view" id="menuView">
            <div class="menu-grid" id="menuGrid">
                </div>
        </div>

        <div class="favorites-view" id="favoritesView">
            <button class="back-btn" id="backToMenu">‚Üê Zur√ºck zur Karte</button>
            <h2>Ihre Favoriten</h2>
            <div class="menu-grid" id="favoritesGrid">
                </div>
        </div>
    </div>

    <div class="popup" id="mealPopup">
        <div class="popup-content">
            <button class="close-btn" id="closePopup">&times;</button>
            <div class="popup-image" id="popupImage">
                
</div>
            <h2 id="popupTitle">Gericht Name</h2>
            <div class="price" id="popupPrice">‚Ç¨ 0,00</div>
            <p class="description" id="popupDescription">Beschreibung des Gerichts...</p>
            <div class="tags" id="popupTags">
                </div>
            <div id="popupIngredients">
                <h4>Zutaten:</h4>
                <ul id="ingredientsList">
                    </ul>
            </div>
            <button class="favorite-popup-btn" id="favoritePopupBtn">‚≠ê Als Favorit speichern</button>
        </div>
    </div>

    <script>
        // --- Daten und Admin State ---
        const initialMenuData = [
            { id: 1, name: "Bruschetta Classica", category: "vorspeisen", price: 6.90, description: "Knuspriges Brot mit frischen Tomaten, Basilikum und Oliven√∂l", tags: ["vegetarisch"], ingredients: ["Baguette", "Tomaten", "Basilikum", "Knoblauch", "Oliven√∂l"], imageBase64: null },
            { id: 2, name: "Spaghetti Carbonara", category: "hauptgerichte", price: 12.90, description: "Klassische italienische Pasta mit Speck, Ei und Pecorino", tags: [], ingredients: ["Spaghetti", "Speck", "Eier", "Pecorino", "Schwarzer Pfeffer"], imageBase64: null },
            { id: 3, name: "Pizza Margherita", category: "hauptgerichte", price: 10.90, description: "Traditionelle Pizza mit Tomatensauce, Mozzarella und Basilikum", tags: ["vegetarisch"], ingredients: ["Pizzateig", "Tomatensauce", "Mozzarella", "Basilikum", "Oliven√∂l"], imageBase64: null },
            { id: 4, name: "Tiramisu", category: "desserts", price: 5.90, description: "Klassisches italienisches Dessert mit Mascarpone und Kaffee", tags: ["vegetarisch"], ingredients: ["Mascarpone", "Eier", "Zucker", "L√∂ffelbiskuits", "Kaffee", "Kakaopulver"], imageBase64: null },
            { id: 5, name: "Vegane Buddha Bowl", category: "hauptgerichte", price: 11.90, description: "Gesunde Bowl mit Quinoa, Gem√ºse und Tahini-Dressing", tags: ["vegan"], ingredients: ["Quinoa", "Avocado", "Karotten", "Gurke", "Tahini", "Zitrone"], imageBase64: null },
            { id: 6, name: "Arancini", category: "vorspeisen", price: 7.50, description: "Gebratene Reisb√§llchen gef√ºllt mit Mozzarella und Erbsen", tags: ["vegetarisch"], ingredients: ["Risotto", "Mozzarella", "Erbsen", "Paniermehl", "Parmesan"], imageBase64: null },
            { id: 7, name: "Espresso", category: "getraenke", price: 2.50, description: "Starker italienischer Kaffee", tags: ["vegan"], ingredients: ["Kaffee"], imageBase64: null }
        ];

        // Kategorien: array von id strings (z.B. "vorspeisen"). 'all' ist virtuelle Kategorie
        const defaultCategories = ['vorspeisen','hauptgerichte','desserts','getraenke'];

        let menuData = loadMenuData();
        let currentFilter = 'all';
        let currentCategory = 'all';
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let currentMealId = null;
        let isAdminMode = false;
        let currentBase64Image = null; // Tempor√§rer Speicher f√ºr Base64-Daten

        // Kategorien laden / speichern
        function loadCategories() {
            const stored = localStorage.getItem('categories');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    // ensure default categories exist if none present
                    if (!Array.isArray(parsed) || parsed.length === 0) {
                        return [...defaultCategories];
                    }
                    return parsed;
                } catch (e) {
                    console.error("Fehler beim Laden der Kategorien:", e);
                    localStorage.setItem('categories', JSON.stringify(defaultCategories));
                    return [...defaultCategories];
                }
            } else {
                localStorage.setItem('categories', JSON.stringify(defaultCategories));
                return [...defaultCategories];
            }
        }
        function saveCategories(cats) {
            localStorage.setItem('categories', JSON.stringify(cats));
        }

        let categories = loadCategories();

        // DOM Elemente
        const menuGrid = document.getElementById('menuGrid');
        const favoritesGrid = document.getElementById('favoritesGrid');
        const mealPopup = document.getElementById('mealPopup');
        const favoritesView = document.getElementById('favoritesView');
        const menuView = document.getElementById('menuView');
        const adminArea = document.getElementById('adminArea');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const menuItemForm = document.getElementById('menuItemForm');
        const saveMealBtn = document.getElementById('saveMealBtn');
        const popupImageDiv = document.getElementById('popupImage');
        const mealImageFile = document.getElementById('mealImageFile');
        const imagePreview = document.getElementById('imagePreview');
        const menuCategoriesContainer = document.getElementById('menuCategoriesContainer');

        const mealCategorySelect = document.getElementById('mealCategory');
        const categoryAdminForm = document.getElementById('categoryAdminForm');
        const newCategoryInput = document.getElementById('newCategoryInput');
        const categoryAdminList = document.getElementById('categoryAdminList');

        // --- Hilfsfunktionen ---
        function loadMenuData() {
            const storedData = localStorage.getItem('menuData');
            if (storedData) {
                try {
                    return JSON.parse(storedData);
                } catch (e) {
                    console.error("Fehler beim Laden der Men√ºdaten aus LocalStorage:", e);
                    localStorage.setItem('menuData', JSON.stringify(initialMenuData));
                    return initialMenuData;
                }
            }
            localStorage.setItem('menuData', JSON.stringify(initialMenuData));
            return initialMenuData;
        }

        function saveMenuData() {
            localStorage.setItem('menuData', JSON.stringify(menuData));
        }

        function slugify(str) {
            return str.toString().toLowerCase().trim().replace(/\s+/g, '-').replace(/[^\w\-√§√∂√º√ü-]+/g, '').replace(/\-\-+/g, '-');
        }

        function displayLabelForCategory(catId) {
            // h√ºbsche Anzeige (z.B. 'vorspeisen' -> 'Vorspeisen')
            if (!catId || catId === 'all') return 'Alle Kategorien';
            // If custom category contains spaces or hyphens, just capitalize words
            return catId.split(/[-_ ]+/).map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');
        }

        function initializeMenu() {
            renderMenuItems();
            renderCategoriesUI();
            setupEventListeners();
        }

        // --- Rendering Funktionen ---
        function renderCategoriesUI() {
            // Men√º-Kategorien-Leiste
            menuCategoriesContainer.innerHTML = '';
            // "Alle Kategorien" button
            const allBtn = document.createElement('button');
            allBtn.className = 'category-btn' + (currentCategory === 'all' ? ' active' : '');
            allBtn.dataset.category = 'all';
            allBtn.textContent = 'Alle Kategorien';
            allBtn.addEventListener('click', () => {
                currentCategory = 'all';
                document.querySelectorAll('#menuCategoriesContainer .category-btn').forEach(b => b.classList.remove('active'));
                allBtn.classList.add('active');
                renderMenuItems();
            });
            menuCategoriesContainer.appendChild(allBtn);

            // Dynamische Kategorie-Buttons
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn' + (currentCategory === cat ? ' active' : '');
                btn.dataset.category = cat;
                btn.textContent = displayLabelForCategory(cat);
                btn.addEventListener('click', () => {
                    currentCategory = cat;
                    document.querySelectorAll('#menuCategoriesContainer .category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderMenuItems();
                });
                menuCategoriesContainer.appendChild(btn);
            });

            // Admin-Select f√ºr mealCategory
            mealCategorySelect.innerHTML = '';
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = displayLabelForCategory(cat);
                mealCategorySelect.appendChild(opt);
            });

            // Kategorie-Liste im Admin
            categoryAdminList.innerHTML = '';
            categories.forEach((cat, index) => {
                const div = document.createElement('div');
                div.className = 'category-admin-item';
                const left = document.createElement('div');
                left.className = 'left';
                const label = document.createElement('div');
                label.textContent = displayLabelForCategory(cat);
                left.appendChild(label);
                const right = document.createElement('div');

                // Nach-oben-Button
                const upBtn = document.createElement('button');
                upBtn.className = 'category-move-btn';
                upBtn.textContent = '‚¨ÜÔ∏è';
                upBtn.title = 'Nach oben verschieben';
                upBtn.disabled = index === 0; // Erste Kategorie kann nicht weiter nach oben
                
                upBtn.addEventListener('click', () => {
                    if (index > 0) {
                        // Tausche mit vorherigem Element
                        [categories[index], categories[index-1]] = [categories[index-1], categories[index]];
                        saveCategories(categories);
                        renderCategoriesUI();
                        renderMenuItems();
                    }
                });

                // Nach-unten-Button  
                const downBtn = document.createElement('button');
                downBtn.className = 'category-move-btn';
                downBtn.textContent = '‚¨áÔ∏è';
                downBtn.title = 'Nach unten verschieben';
                downBtn.disabled = index === categories.length - 1; // Letzte Kategorie kann nicht weiter nach unten
                
                downBtn.addEventListener('click', () => {
                    if (index < categories.length - 1) {
                        // Tausche mit n√§chstem Element
                        [categories[index], categories[index+1]] = [categories[index+1], categories[index]];
                        saveCategories(categories);
                        renderCategoriesUI();
                        renderMenuItems();
                    }
                });

                // Bearbeiten-Button
                const editBtn = document.createElement('button');
                editBtn.className = 'category-edit-btn';
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.title = 'Umbenennen';
                editBtn.addEventListener('click', () => {
                    const newLabel = prompt('Neuer Name f√ºr Kategorie (Anzeige):', displayLabelForCategory(cat));
                    if (!newLabel) return;
                    const newId = slugify(newLabel);
                    if (newId === cat) {
                        alert('Kategorie unver√§ndert oder bereits vorhanden.');
                        return;
                    }
                    if (categories.includes(newId)) {
                        alert('Eine Kategorie mit diesem Namen existiert bereits.');
                        return;
                    }
                    const idx = categories.indexOf(cat);
                    if (idx !== -1) {
                        const oldId = categories[idx];
                        categories[idx] = newId;
                        menuData = menuData.map(m => m.category === oldId ? { ...m, category: newId } : m);
                        saveCategories(categories);
                        saveMenuData();
                        renderCategoriesUI();
                        renderMenuItems();
                    }
                });

                // L√∂schen-Button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'category-delete-btn';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.title = 'L√∂schen';
                deleteBtn.addEventListener('click', () => {
                    if (confirm(`Kategorie "${displayLabelForCategory(cat)}" wirklich l√∂schen? Alle Gerichte dieser Kategorie werden ebenfalls gel√∂scht.`)) {
                        categories = categories.filter(c => c !== cat);
                        menuData = menuData.filter(m => m.category !== cat);
                        saveCategories(categories);
                        saveMenuData();
                        if (currentCategory === cat) currentCategory = 'all';
                        renderCategoriesUI();
                        renderMenuItems();
                    }
                });

                // Buttons in Reihenfolge hinzuf√ºgen
                right.appendChild(upBtn);
                right.appendChild(downBtn);
                right.appendChild(editBtn);
                right.appendChild(deleteBtn);

                div.appendChild(left);
                div.appendChild(right);
                categoryAdminList.appendChild(div);
            });
        }

        function renderMenuItems() {
            menuGrid.innerHTML = '';
            
            const filteredMeals = menuData.filter(meal => {
                const categoryMatch = currentCategory === 'all' || meal.category === currentCategory;
                const filterMatch = currentFilter === 'all' || (meal.tags && meal.tags.includes(currentFilter));
                return categoryMatch && filterMatch;
            });

            filteredMeals.forEach(meal => {
                const mealElement = createMealElement(meal);
                menuGrid.appendChild(mealElement);
            });
        }

        function renderFavorites() {
            favoritesGrid.innerHTML = '';
            if (favorites.length === 0) {
                favoritesGrid.innerHTML = '<p>Noch keine Favoriten gespeichert.</p>';
                return;
            }

            favorites.forEach(mealId => {
                const meal = menuData.find(m => m.id === mealId);
                if (meal) {
                    const mealElement = createMealElement(meal);
                    favoritesGrid.appendChild(mealElement);
                }
            });
        }

        function createMealElement(meal) {
            const div = document.createElement('div');
            div.className = 'menu-item';
            div.setAttribute('data-id', meal.id);
            
            const tagsHTML = (meal.tags || []).map(tag => 
                `<span class="tag ${tag}">${tag}</span>`
            ).join('');
            
            let adminControls = '';
            if (isAdminMode) {
                adminControls = `
                    <div class="admin-controls-item">
                        <button class="admin-edit-btn" data-id="${meal.id}" title="Bearbeiten">‚úèÔ∏è</button>
                        <button class="admin-delete-btn" data-id="${meal.id}" title="L√∂schen">üóëÔ∏è</button>
                    </div>
                `;
            }

            div.innerHTML = `
                ${adminControls}
                <h3>${meal.name}</h3>
                <div class="price">‚Ç¨ ${meal.price ? meal.price.toFixed(2) : '0.00'}</div>
                <p class="description">${meal.description || 'Keine Beschreibung'}</p>
                <div class="tags">
                    ${tagsHTML}
                    ${favorites.includes(meal.id) ? '<span class="tag" style="background:#ffeaa7;">‚≠ê Favorit</span>' : ''}
                </div>
            `;
            
            return div;
        }

        function openMealPopup(mealId) {
            const meal = menuData.find(m => m.id === mealId);
            if (!meal) return;

            currentMealId = mealId;
            
            popupImageDiv.innerHTML = '';
            if (meal.imageBase64) {
                const img = document.createElement('img');
                img.src = meal.imageBase64;
                img.alt = meal.name;
                popupImageDiv.appendChild(img);
            } else {
                popupImageDiv.textContent = `[Kein Bild verf√ºgbar f√ºr ${meal.name}]`;
            }

            document.getElementById('popupTitle').textContent = meal.name;
            document.getElementById('popupPrice').textContent = `‚Ç¨ ${meal.price.toFixed(2)}`;
            document.getElementById('popupDescription').textContent = meal.description;
            
            const tagsContainer = document.getElementById('popupTags');
            tagsContainer.innerHTML = (meal.tags || []).map(tag => 
                `<span class="tag ${tag}">${tag}</span>`
            ).join('');
            
            const ingredientsList = document.getElementById('ingredientsList');
            ingredientsList.innerHTML = (meal.ingredients || []).map(ingredient => 
                `<li>${ingredient}</li>`
            ).join('');
            
            const favoriteBtn = document.getElementById('favoritePopupBtn');
            const isFavorite = favorites.includes(mealId);
            favoriteBtn.textContent = isFavorite ? '‚úÖ Entfernen aus Favoriten' : '‚≠ê Als Favorit speichern';
            favoriteBtn.classList.toggle('added', isFavorite);
            
            mealPopup.style.display = 'flex';
        }

        function toggleFavorite(mealId) {
            const index = favorites.indexOf(mealId);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(mealId);
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            
            if (currentMealId === mealId) {
                const favoriteBtn = document.getElementById('favoritePopupBtn');
                const isFavorite = favorites.includes(mealId);
                favoriteBtn.textContent = isFavorite ? '‚úÖ Entfernen aus Favoriten' : '‚≠ê Als Favorit speichern';
                favoriteBtn.classList.toggle('added', isFavorite);
            }
            
            renderMenuItems();
            if (favoritesView.style.display === 'block') {
                renderFavorites();
            }
        }
        
        // --- Admin-Funktionen ---
        
        function toggleAdminMode(login = true) {
            if (login) {
                const password = prompt("Geben Sie Ihr Passwort ein, um den Admin-Bereich zu betreten:");
                if (password !== "admin123") {
                    alert("Falsches Passwort.");
                    return;
                }
                isAdminMode = true;
                adminArea.style.display = 'block';
            } else {
                isAdminMode = false;
                adminArea.style.display = 'none';
                resetForm();
            }
            renderMenuItems();
        }

        function fillFormForEdit(mealId) {
            const meal = menuData.find(m => m.id === mealId);
            if (!meal) return;

            document.getElementById('mealIdInput').value = meal.id;
            document.getElementById('mealName').value = meal.name;
            document.getElementById('mealCategory').value = meal.category;
            document.getElementById('mealPrice').value = meal.price.toFixed(2);
            document.getElementById('mealDescription').value = meal.description;
            document.getElementById('mealTags').value = (meal.tags || []).join(',');
            document.getElementById('mealIngredients').value = (meal.ingredients || []).join(',');
            
            currentBase64Image = meal.imageBase64 || null;
            updateImagePreview(currentBase64Image);

            saveMealBtn.textContent = '√Ñnderungen speichern';
        }
        
        function updateImagePreview(base64Data) {
            imagePreview.innerHTML = '';
            if (base64Data) {
                const img = document.createElement('img');
                img.src = base64Data;
                imagePreview.appendChild(img);
            } else {
                imagePreview.textContent = 'Bildvorschau';
            }
        }

        function resetForm() {
            menuItemForm.reset();
            document.getElementById('mealIdInput').value = '';
            saveMealBtn.textContent = 'Men√ºpunkt speichern';
            currentBase64Image = null;
            updateImagePreview(null);
        }
        
        // NEU: Funktion zur Bildverkleinerung und Konvertierung
        function resizeImage(file, maxWidth = 400, maxHeight = 400, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        // Zeichne das Bild skaliert auf den Canvas
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Konvertiere Canvas-Inhalt in Base64 (JPEG f√ºr bessere Komprimierung)
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function saveMenuItem(e) {
            e.preventDefault();

            const file = mealImageFile.files[0];
            let imageToSave = currentBase64Image;

            if (file) {
                try {
                    // Verwende die neue Skalierungsfunktion
                    imageToSave = await resizeImage(file);
                } catch (error) {
                    alert("Fehler beim Verarbeiten des Bildes.");
                    console.error(error);
                    return;
                }
            } 

            const id = document.getElementById('mealIdInput').value;
            const name = document.getElementById('mealName').value;
            const category = document.getElementById('mealCategory').value;
            const price = parseFloat(document.getElementById('mealPrice').value);
            const description = document.getElementById('mealDescription').value;
            const tags = document.getElementById('mealTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const ingredients = document.getElementById('mealIngredients').value.split(',').map(item => item.trim()).filter(item => item);

            const newMeal = {
                name,
                category,
                price,
                description,
                tags,
                ingredients,
                imageBase64: imageToSave
            };

            if (id) {
                const index = menuData.findIndex(m => m.id === parseInt(id));
                if (index !== -1) {
                    menuData[index] = { ...menuData[index], ...newMeal };
                    alert(`Gericht "${name}" erfolgreich aktualisiert!`);
                }
            } else {
                const newId = menuData.length > 0 ? Math.max(...menuData.map(m => m.id)) + 1 : 1;
                menuData.push({ id: newId, ...newMeal });
                alert(`Gericht "${name}" erfolgreich hinzugef√ºgt!`);
            }

            saveMenuData();
            resetForm();
            renderMenuItems();
        }

        function deleteMenuItem(mealId) {
            if (confirm("Sind Sie sicher, dass Sie dieses Gericht l√∂schen m√∂chten?")) {
                menuData = menuData.filter(m => m.id !== mealId);
                saveMenuData();
                renderMenuItems();
                alert("Gericht gel√∂scht.");
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // ... (Filter, Kategorie Events unver√§ndert) ...
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderMenuItems();
                });
            });

            // Admin Logout Button
            adminLogoutBtn.addEventListener('click', () => toggleAdminMode(false));

            // Bilddatei-Input f√ºr Vorschau
            mealImageFile.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        // VORSCHAU: Wir zeigen die unkomprimierte/nicht skalierte Vorschau an
                        const base64Preview = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.readAsDataURL(file);
                        });
                        currentBase64Image = base64Preview; // Tempor√§r setzen
                        updateImagePreview(base64Preview);
                    } catch (err) {
                        console.error("Fehler beim Lesen der Datei:", err);
                        alert("Fehler beim Lesen der Datei.");
                    }
                } else {
                    // Beim L√∂schen des Inputs: entweder zu Null setzen (bei Neu) oder alten Wert behalten (bei Edit)
                    if (document.getElementById('mealIdInput').value === '') {
                         currentBase64Image = null; 
                    }
                    updateImagePreview(currentBase64Image);
                }
            });

            // REPARATUR: Men√ºpunkt Klicks (Delegierung)
            menuGrid.addEventListener('click', (e) => {
                const target = e.target;
                const menuItem = target.closest('.menu-item');
                
                if (!menuItem) return;

                const mealId = parseInt(menuItem.dataset.id);

                if (isAdminMode) {
                    if (target.classList.contains('admin-edit-btn')) {
                        fillFormForEdit(mealId);
                        adminArea.scrollIntoView({ behavior: 'smooth' });
                        return;
                    } 
                    if (target.classList.contains('admin-delete-btn')) {
                        deleteMenuItem(mealId);
                        return;
                    }
                    // Wenn Admin Mode aktiv und Klick auf das Item selbst (oder Unterelement ohne eigene Action): Bearbeiten
                    fillFormForEdit(mealId);
                    adminArea.scrollIntoView({ behavior: 'smooth' });
                    return;
                }

                // Normaler Modus: Popup √∂ffnen
                openMealPopup(mealId);
            });
            
            // Favoriten Grid Klicks (Popup)
            favoritesGrid.addEventListener('click', (e) => {
                const menuItem = e.target.closest('.menu-item');
                if (menuItem) {
                    const mealId = parseInt(menuItem.dataset.id);
                    openMealPopup(mealId);
                }
            });
            
            // NEU: Admin Event Listeners f√ºr Formularaktionen
            menuItemForm.addEventListener('submit', saveMenuItem);
            document.getElementById('resetFormBtn').addEventListener('click', resetForm);

            // Kategorie Admin hinzuf√ºgen
            categoryAdminForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const raw = newCategoryInput.value.trim();
                if (!raw) return;
                const id = slugify(raw);
                if (id === '' || categories.includes(id)) {
                    alert('Kategorie existiert bereits oder ung√ºltig.');
                    return;
                }
                categories.push(id);
                saveCategories(categories);
                newCategoryInput.value = '';
                renderCategoriesUI();
            });

            // Tastenkombination f√ºr Admin-Bereich
            document.addEventListener('keydown', (e) => {
                if (!isAdminMode && (e.ctrlKey && e.altKey && e.key === 'a' || e.metaKey && e.altKey && e.key === 'a')) {
                    e.preventDefault();
                    toggleAdminMode(true);
                }
            });
            
            // Popup-Aktionen
            document.getElementById('closePopup').addEventListener('click', () => {
                mealPopup.style.display = 'none';
            });
            document.getElementById('favoritePopupBtn').addEventListener('click', () => {
                toggleFavorite(currentMealId);
            });
            mealPopup.addEventListener('click', (e) => {
                if (e.target === mealPopup) {
                    mealPopup.style.display = 'none';
                }
            });

            // Favoriten anzeigen/zur√ºck
            document.getElementById('showFavorites').addEventListener('click', () => {
                menuView.style.display = 'none';
                favoritesView.style.display = 'block';
                renderFavorites();
            });

            document.getElementById('backToMenu').addEventListener('click', () => {
                favoritesView.style.display = 'none';
                menuView.style.display = 'block';
            });
        }

        document.addEventListener('DOMContentLoaded', initializeMenu);
    </script>
</body>
</html>